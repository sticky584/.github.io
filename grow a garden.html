<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grow a Garden</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .shadow-text {
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .animate-fade-in-quick {
            animation: fadeIn 0.2s ease-out forwards;
        }
        /* Custom class for smooth emoji resizing */
        .plant-emoji-size {
            font-size: 3rem; /* Base size for growing plant, equivalent to text-5xl */
            transition: font-size 0.5s ease-out; /* Smooth transition for size changes */
        }
        .text-6xl-dynamic {
            font-size: 3.75rem; /* Base for grown plant */
        }
        .text-7xl-dynamic {
            font-size: 4.5rem; /* Larger for mutated/big plants */
        }
        /* Styles for weather effects */
        .weather-effect-emoji {
            position: absolute;
            font-size: 1.5rem; /* Small emoji size */
            z-index: 10; /* Ensure it's above the plant */
        }
        .weather-effect-drop {
            top: 5px;
            right: 5px;
        }
        .weather-effect-lightning {
            top: 5px;
            left: 5px;
        }

        /* Weather Overlay Styles */
        #weather-overlay {
            background-color: transparent; /* Default */
            transition: background-color 0.5s ease-in-out, backdrop-filter 0.5s ease-in-out;
        }

        /* Rain Effect */
        .rain-effect::before {
            content: '';
            position: absolute;
            top: -100%; /* Start above screen */
            left: 0;
            width: 100%;
            height: 200%; /* Make it long enough for animation */
            background-image: radial-gradient(circle at 10% 10%, rgba(100, 150, 255, 0.6) 1px, transparent 1px),
                              radial-gradient(circle at 30% 20%, rgba(100, 150, 255, 0.6) 1px, transparent 1px),
                              radial-gradient(circle at 50% 30%, rgba(100, 150, 255, 0.6) 1px, transparent 1px),
                              radial-gradient(circle at 70% 40%, rgba(100, 150, 255, 0.6) 1px, transparent 1px),
                              radial-gradient(circle at 90% 50%, rgba(100, 150, 255, 0.6) 1px, transparent 1px);
            background-size: 10px 10px; /* Size of raindrops */
            animation: rainFall 1s linear infinite;
            pointer-events: none; /* Allow clicks to pass through */
        }

        @keyframes rainFall {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0.5; }
        }

        /* Thunderstorm Effect (combines rain with lightning) */
        .thunderstorm-effect {
            animation: lightningFlash 3s infinite alternate; /* Main lightning flash on overlay */
        }

        .thunderstorm-effect::before {
            content: ''; /* Inherit rain effect from rain-effect or redefine */
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 200%;
            background-image: radial-gradient(circle at 10% 10%, rgba(100, 150, 255, 0.6) 1px, transparent 1px),
                              radial-gradient(circle at 30% 20%, rgba(100, 150, 255, 0.6) 1px, transparent 1px),
                              radial-gradient(circle at 50% 30%, rgba(100, 150, 255, 0.6) 1px, transparent 1px),
                              radial-gradient(circle at 70% 40%, rgba(100, 150, 255, 0.6) 1px, transparent 1px),
                              radial-gradient(circle at 90% 50%, rgba(100, 150, 255, 0.6) 1px, transparent 1px);
            background-size: 10px 10px;
            animation: rainFall 1s linear infinite; /* Rain part of thunderstorm */
            pointer-events: none;
        }

        @keyframes lightningFlash {
            0%, 90% { background-color: rgba(0, 0, 0, 0); }
            95% { background-color: rgba(255, 255, 200, 0.4); } /* Yellowish flash */
            100% { background-color: rgba(0, 0, 0, 0); }
        }

        /* Snow Effect */
        .snow-effect::before {
            content: '';
            position: absolute;
            top: -100%;
            left: 0;
            width: 100%;
            height: 200%;
            background-image: radial-gradient(circle at 10% 10%, rgba(255, 255, 255, 0.8) 2px, transparent 2px),
                              radial-gradient(circle at 25% 15%, rgba(255, 255, 255, 0.8) 2px, transparent 2px),
                              radial-gradient(circle at 40% 20%, rgba(255, 255, 255, 0.8) 2px, transparent 2px),
                              radial-gradient(circle at 55% 25%, rgba(255, 255, 255, 0.8) 2px, transparent 2px),
                              radial-gradient(circle at 70% 30%, rgba(255, 255, 255, 0.8) 2px, transparent 2px),
                              radial-gradient(circle at 85% 35%, rgba(255, 255, 255, 0.8) 2px, transparent 2px);
            background-size: 15px 15px; /* Size of snowflakes */
            animation: snowFall 5s linear infinite;
            pointer-events: none;
        }

        @keyframes snowFall {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(100%); opacity: 0.7; }
        }

        /* Fog Effect */
        .fog-effect {
            background-color: rgba(200, 200, 200, 0.3); /* Semi-transparent grey */
            backdrop-filter: blur(2px); /* Subtle blur */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-b from-blue-100 to-green-200 text-gray-800 p-4 sm:p-6 md:p-8 flex flex-col items-center relative">

    <!-- Weather Overlay -->
    <div id="weather-overlay" class="fixed inset-0 pointer-events-none z-30"></div>

    <!-- Main Game Container -->
    <h1 class="text-5xl md:text-6xl font-extrabold text-emerald-800 mb-8 text-center shadow-text">
        Grow a Garden üå±
    </h1>

    <!-- Header: Money & Shop Timer -->
    <div class="bg-gradient-to-r from-emerald-600 to-green-700 p-4 rounded-xl shadow-lg border-2 border-emerald-800 mb-8 w-full max-w-4xl flex flex-col sm:flex-row justify-around items-center text-white font-bold text-lg sm:text-xl transition-all duration-300 transform hover:scale-[1.01]">
        <div class="flex items-center mb-2 sm:mb-0">
            <span class="mr-2">üí∞</span> Money: <span id="money-display" class="ml-1 text-yellow-300">$200</span>
        </div>
        <div class="flex items-center">
            <span class="mr-2">‚è∞</span> Shop Resets In: <span id="shop-timer" class="ml-1">05:00</span>
        </div>
    </div>

    <!-- Weather Control Panel -->
    <div id="weather-panel" class="absolute top-4 right-4 bg-white bg-opacity-90 p-4 rounded-xl shadow-lg border-2 border-gray-300 flex flex-col gap-3 z-40 animate-fade-in">
        <h3 class="text-xl font-bold text-gray-800 text-center">Weather üå§Ô∏è</h3>
        <button id="weather-clear-btn" class="weather-btn px-4 py-2 bg-blue-400 text-white font-semibold rounded-lg shadow-md hover:bg-blue-500 transition-colors duration-200 transform hover:scale-105">
            ‚òÄÔ∏è Clear
        </button>
        <button id="weather-rain-btn" class="weather-btn px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200 transform hover:scale-105">
            üåßÔ∏è Rain
        </button>
        <button id="weather-thunderstorm-btn" class="weather-btn px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg shadow-md hover:bg-gray-800 transition-colors duration-200 transform hover:scale-105">
            ‚õàÔ∏è Thunderstorm
        </button>
        <button id="weather-snow-btn" class="weather-btn px-4 py-2 bg-blue-200 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-blue-300 transition-colors duration-200 transform hover:scale-105">
            ‚ùÑÔ∏è Snow
        </button>
        <button id="weather-fog-btn" class="weather-btn px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg shadow-md hover:bg-gray-500 transition-colors duration-200 transform hover:scale-105">
            üå´Ô∏è Fog
        </button>
        <p class="text-sm text-gray-600 text-center mt-2">Active: <span id="current-weather-display" class="font-bold">None</span></p>
    </div>

    <!-- Shops and Inventory Grid -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-7xl mb-8">
        <!-- Seed Shop -->
        <div id="seed-shop" class="bg-gradient-to-br from-lime-500 to-green-600 p-6 rounded-xl shadow-lg border-2 border-green-700 transform transition-all hover:scale-[1.01] duration-300">
            <h2 class="text-3xl font-extrabold text-white mb-6 text-center shadow-text">Seed Shop üå±</h2>
            <div id="seed-list" class="grid grid-cols-1 gap-4">
                <!-- Seed items will be dynamically inserted here -->
            </div>
        </div>

        <!-- Tool Shop -->
        <div id="tool-shop" class="bg-gradient-to-br from-blue-400 to-indigo-500 p-6 rounded-xl shadow-lg border-2 border-blue-600 transform transition-all hover:scale-[1.01] duration-300">
            <h2 class="text-3xl font-extrabold text-white mb-6 text-center shadow-text">Tool Shop üõ†Ô∏è</h2>
            <div id="tool-list" class="grid grid-cols-1 gap-4">
                <!-- Tool items will be dynamically inserted here -->
            </div>
        </div>

        <!-- Inventory -->
        <div id="inventory-display" class="bg-gradient-to-br from-emerald-500 to-green-700 p-6 rounded-xl shadow-lg border-2 border-emerald-800 text-white transform transition-all hover:scale-[1.01] duration-300">
            <h2 class="text-3xl font-extrabold text-white mb-6 text-center shadow-text">Your Inventory üí∞</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center bg-white bg-opacity-20 p-3 rounded-lg shadow-inner">
                    <span class="text-xl font-bold">Money:</span>
                    <span id="inventory-money" class="text-xl font-bold text-yellow-300">$200</span>
                </div>

                <div class="bg-white bg-opacity-20 p-3 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold mb-2">Seeds:</h3>
                    <ul id="inventory-seeds" class="list-disc list-inside space-y-1">
                        <!-- Seed inventory will be dynamically inserted here -->
                    </ul>
                </div>

                <div class="bg-white bg-opacity-20 p-3 rounded-lg shadow-inner">
                    <h3 class="lg font-semibold mb-2">Tools:</h3>
                    <ul id="inventory-tools" class="list-disc list-inside space-y-1">
                        <!-- Tool inventory will be dynamically inserted here -->
                    </ul>
                </div>

                <div class="bg-white bg-opacity-20 p-3 rounded-lg shadow-inner">
                    <h3 class="text-lg font-semibold mb-2">Produce:</h3>
                    <div id="inventory-produce-list" class="grid grid-cols-1 gap-2">
                        <!-- Produce inventory with sell controls will be dynamically inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Garden Plots -->
    <div class="bg-gradient-to-br from-lime-300 to-green-400 p-6 rounded-xl shadow-2xl border-4 border-green-500 w-full max-w-7xl mb-8">
        <h2 class="text-4xl font-extrabold text-green-800 mb-8 text-center shadow-text">Your Garden üå≥</h2>
        <div id="garden-plots" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Garden plots will be dynamically inserted here -->
        </div>
    </div>

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 max-w-sm w-full border-4 border-emerald-500 transform transition-all duration-300 scale-100 opacity-100 animate-fade-in">
            <div class="text-center">
                <p id="message-text" class="text-xl md:text-2xl font-bold text-gray-800 mb-6 leading-tight"></p>
                <button id="message-ok-btn" class="px-6 py-3 bg-emerald-600 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-opacity-75 transform hover:scale-105">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports (boilerplate - not used for game logic persistence yet)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Included for boilerplate

        // --- Firebase Init (boilerplate - not used for game logic persistence yet) ---
        let db = null;
        let auth = null;
        let currentUserId = null;
        let isAuthReady = false;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUserId = user.uid;
                    } else {
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            currentUserId = crypto.randomUUID(); // Fallback
                        }
                    }
                    isAuthReady = true;
                    console.log("Firebase Auth Ready. User ID:", currentUserId);
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                currentUserId = crypto.randomUUID(); // Fallback
                isAuthReady = true;
            }
        }
        // Call Firebase init on window load
        window.addEventListener('load', initFirebase);


        // --- Game Data Definitions ---
        const SEED_TYPES = {
            tomato: {
                name: 'Tomato Seed',
                price: 10,
                rarity: 'common',
                growthTime: 30 * 1000, // 30 seconds
                yield: { produce: 'tomato', amount: 1 },
                icon: 'üçÖ',
                harvestValue: 15,
                minWeightMultiplier: 0.8,
                maxWeightMultiplier: 1.5,
                baseEmojiSize: 3, // Corresponds to Tailwind's text-3xl for initial growth
                grownEmojiSize: 3.75, // Corresponds to Tailwind's text-6xl-dynamic for fully grown
            },
            carrot: {
                name: 'Carrot Seed',
                price: 8,
                rarity: 'common',
                growthTime: 25 * 1000, // 25 seconds
                yield: { produce: 'carrot', amount: 1 },
                icon: 'ü•ï',
                harvestValue: 12,
                minWeightMultiplier: 0.7,
                maxWeightMultiplier: 1.3,
                baseEmojiSize: 3,
                grownEmojiSize: 3.75,
            },
            pumpkin: {
                name: 'Pumpkin Seed',
                price: 25,
                rarity: 'rare',
                growthTime: 60 * 1000, // 60 seconds
                yield: { produce: 'pumpkin', amount: 1 },
                icon: 'üéÉ',
                harvestValue: 40,
                minWeightMultiplier: 1.0,
                maxWeightMultiplier: 2.5,
                baseEmojiSize: 3,
                grownEmojiSize: 4.5, // Pumpkins can be bigger base size
            },
            strawberry: { // New Seed Type
                name: 'Strawberry Seed',
                price: 7,
                rarity: 'common',
                growthTime: 20 * 1000, // 20 seconds
                yield: { produce: 'strawberry', amount: 3 }, // Yields multiple
                icon: 'üçì',
                harvestValue: 5,
                minWeightMultiplier: 0.6,
                maxWeightMultiplier: 1.1,
                baseEmojiSize: 2.5, // Smaller initial
                grownEmojiSize: 3.25,
            },
            blueberry: { // New Seed Type
                name: 'Blueberry Seed',
                price: 9,
                rarity: 'common',
                growthTime: 22 * 1000, // 22 seconds
                yield: { produce: 'blueberry', amount: 5 }, // Yields multiple
                icon: 'ü´ê',
                harvestValue: 4,
                minWeightMultiplier: 0.5,
                maxWeightMultiplier: 1.0,
                baseEmojiSize: 2.5,
                grownEmojiSize: 3.25,
            },
        };

        const TOOL_TYPES = {
            wateringCan: {
                name: 'Watering Can',
                price: 50,
                description: 'Makes plants grow 2x faster for one use.',
                icon: 'üíß',
                growthBoostFactor: 2,
            },
            superFertilizer: {
                name: 'Super Fertilizer',
                price: 150,
                description: 'Makes plants grow 3x faster for one use.',
                icon: '‚ú®',
                growthBoostFactor: 3,
            },
            pesticideSpray: {
                name: 'Pesticide Spray',
                price: 75,
                description: 'Protects a plant from pests (future feature).',
                icon: 'ÔøΩ',
            },
            basicSprinkler: { // New Tool: Basic Sprinkler
                name: 'Basic Sprinkler',
                price: 100,
                description: 'Increases growth speed (1.5x), small size bonus chance (1.2x max) & mutation chance (5%).',
                icon: 'üöø',
                growthBoostFactor: 1.5,
                sizeBonusMultiplier: 1.2, // Max multiplier for size increase from sprinkler
                mutationChance: 0.05, // 5% chance for mutation
            },
            advancedSprinkler: { // New Tool: Advanced Sprinkler
                name: 'Advanced Sprinkler',
                price: 250,
                description: 'Significantly boosts growth (2x), good size bonus (1.5x max) & mutation chance (20%).',
                icon: 'üåà',
                growthBoostFactor: 2,
                sizeBonusMultiplier: 1.5, // Max multiplier for size increase from sprinkler
                mutationChance: 0.20, // 20% chance for mutation
            },
        };

        const WEATHER_TYPES = {
            clear: { name: 'Clear', icon: '‚òÄÔ∏è', isWet: false, canStrikeLightning: false },
            rain: { name: 'Rain', icon: 'üåßÔ∏è', isWet: true, canStrikeLightning: false },
            thunderstorm: { name: 'Thunderstorm', icon: '‚õàÔ∏è', isWet: true, canStrikeLightning: true },
            snow: { name: 'Snow', icon: '‚ùÑÔ∏è', isWet: false, canStrikeLightning: false },
            fog: { name: 'Fog', icon: 'üå´Ô∏è', isWet: false, canStrikeLightning: false },
        };

        // --- Game State (Global Variables) ---
        let money = 200;
        let inventory = {
            seeds: {},
            tools: { wateringCan: 0, superFertilizer: 0, pesticideSpray: 0, basicSprinkler: 0, advancedSprinkler: 0 },
            produce: {},
        };
        let plants = Array(8).fill(null); // 8 garden plots, initialized as null
        let shopSeeds = [];
        let shopTools = [];
        let shopResetTimer = 0;
        const SHOP_RESET_INTERVAL = 5 * 60; // 5 minutes in seconds

        let currentWeather = null; // e.g., 'rain', 'thunderstorm'
        let weatherTimerId = null;
        const WEATHER_ACTIVE_DURATION = 30 * 1000; // 30 seconds

        // --- DOM Elements ---
        const moneyDisplay = document.getElementById('money-display');
        const shopTimerDisplay = document.getElementById('shop-timer');
        const seedListContainer = document.getElementById('seed-list');
        const toolListContainer = document.getElementById('tool-list');
        const inventoryMoneyDisplay = document.getElementById('inventory-money');
        const inventorySeedsList = document.getElementById('inventory-seeds');
        const inventoryToolsList = document.getElementById('inventory-tools');
        const inventoryProduceListContainer = document.getElementById('inventory-produce-list');
        const gardenPlotsContainer = document.getElementById('garden-plots');
        const messageModal = document.getElementById('message-modal');
        const messageText = document.getElementById('message-text');
        const messageOkBtn = document.getElementById('message-ok-btn');

        // Weather panel elements
        const weatherClearBtn = document.getElementById('weather-clear-btn');
        const weatherRainBtn = document.getElementById('weather-rain-btn');
        const weatherThunderstormBtn = document.getElementById('weather-thunderstorm-btn');
        const weatherSnowBtn = document.getElementById('weather-snow-btn'); // New button
        const weatherFogBtn = document.getElementById('weather-fog-btn');   // New button
        const currentWeatherDisplay = document.getElementById('current-weather-display');
        const weatherOverlay = document.getElementById('weather-overlay'); // New weather overlay element

        // --- Helper Functions ---

        /**
         * Displays a modal message to the user.
         * @param {string} message - The message to display.
         */
        function showMessage(message) {
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
            messageModal.classList.add('animate-fade-in');
        }

        /**
         * Hides the modal message.
         */
        function hideMessage() {
            messageModal.classList.add('hidden');
        }

        // Event listener for the OK button in the message modal
        messageOkBtn.addEventListener('click', hideMessage);

        /**
         * Generates a random set of seeds for the shop.
         * Includes a mix of common and a chance for rare seeds.
         * @returns {Array} An array of seed objects for the shop.
         */
        const generateShopSeeds = () => {
            const seeds = [];
            const commonSeeds = Object.values(SEED_TYPES).filter(s => s.rarity === 'common');
            const rareSeeds = Object.values(SEED_TYPES).filter(s => s.rarity === 'rare');

            // Always include a few common seeds
            for (let i = 0; i < 3; i++) {
                seeds.push(commonSeeds[Math.floor(Math.random() * commonSeeds.length)]);
            }

            // Small chance for a rare seed
            if (Math.random() < 0.3) { // 30% chance for a rare seed
                seeds.push(rareSeeds[Math.floor(Math.random() * rareSeeds.length)]);
            }

            return seeds;
        };

        /**
         * Generates a random set of tools for the shop.
         * @returns {Array} An array of tool objects for the shop.
         */
        const generateShopTools = () => {
            // Include all tools in the shop for simplicity
            return Object.values(TOOL_TYPES);
        };

        /**
         * Updates the money display in the header and inventory.
         */
        const updateMoneyDisplay = () => {
            moneyDisplay.textContent = `$${money}`;
            inventoryMoneyDisplay.textContent = `$${money}`;
            // Re-render shops to update buy button disabled states
            renderSeedShop();
            renderToolShop();
        };

        /**
         * Renders the seed shop UI based on current shopSeeds.
         */
        const renderSeedShop = () => {
            seedListContainer.innerHTML = ''; // Clear previous items
            shopSeeds.forEach((seed, index) => {
                const seedDiv = document.createElement('div');
                seedDiv.className = "bg-white bg-opacity-95 p-4 rounded-lg shadow-md flex flex-col sm:flex-row items-center justify-between border border-lime-300 transition-all hover:border-emerald-500 hover:shadow-lg";
                
                const seedTypeKey = Object.keys(SEED_TYPES).find(key => SEED_TYPES[key] === seed);

                seedDiv.innerHTML = `
                    <div class="flex-grow text-center sm:text-left mb-2 sm:mb-0">
                        <p class="text-xl font-bold text-gray-800">${seed.icon} ${seed.name}</p>
                        <p class="text-gray-600 text-sm">Growth Time: ${seed.growthTime / 1000}s</p>
                        <p class="text-sm font-semibold ${seed.rarity === 'rare' ? 'text-purple-600' : 'text-gray-500'}">Rarity: ${seed.rarity}</p>
                    </div>
                    <div class="flex flex-col items-center gap-2">
                        <span class="text-xl font-bold text-emerald-700">$<span id="seed-price-${seedTypeKey}-${index}">${seed.price}</span></span>
                        <div class="flex items-center gap-1">
                            <button class="quantity-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors" data-action="decrease" data-item-type="seed" data-seed-key="${seedTypeKey}" data-index="${index}">-</button>
                            <input type="number" value="1" min="1" class="w-12 text-center border rounded-lg" id="seed-quantity-${seedTypeKey}-${index}" readonly>
                            <button class="quantity-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors" data-action="increase" data-item-type="seed" data-seed-key="${seedTypeKey}" data-index="${index}">+</button>
                        </div>
                        <button class="buy-seed-btn px-5 py-2 bg-emerald-700 text-white font-bold rounded-lg shadow-md hover:bg-emerald-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 transform hover:scale-105" data-seed-type="${seedTypeKey}" data-index="${index}">
                            Buy
                        </button>
                    </div>
                `;
                seedListContainer.appendChild(seedDiv);

                const quantityInput = document.getElementById(`seed-quantity-${seedTypeKey}-${index}`);
                const buyBtn = seedDiv.querySelector('.buy-seed-btn');

                const updateBuyButtonState = () => {
                    const quantity = parseInt(quantityInput.value);
                    const totalPrice = seed.price * quantity;
                    buyBtn.disabled = money < totalPrice;
                    seedDiv.querySelector(`#seed-price-${seedTypeKey}-${index}`).textContent = totalPrice; // Update displayed price
                };

                seedDiv.querySelectorAll('.quantity-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        let quantity = parseInt(quantityInput.value);
                        if (btn.dataset.action === 'increase') {
                            quantity++;
                        } else if (btn.dataset.action === 'decrease') {
                            quantity = Math.max(1, quantity - 1);
                        }
                        quantityInput.value = quantity;
                        updateBuyButtonState();
                    });
                });

                buyBtn.addEventListener('click', () => {
                    const quantity = parseInt(quantityInput.value);
                    handleBuySeed(seed, quantity);
                    quantityInput.value = 1; // Reset quantity after purchase
                });
                updateBuyButtonState(); // Initial state update
            });
        };

        /**
         * Renders the tool shop UI based on current shopTools.
         */
        const renderToolShop = () => {
            toolListContainer.innerHTML = ''; // Clear previous items
            shopTools.forEach((tool, index) => {
                const toolDiv = document.createElement('div');
                toolDiv.className = "bg-white bg-opacity-95 p-4 rounded-lg shadow-md flex items-center justify-between border border-blue-300 transition-all hover:border-indigo-500 hover:shadow-lg";
                toolDiv.innerHTML = `
                    <div class="flex-grow">
                        <p class="text-xl font-bold text-gray-800">${tool.icon} ${tool.name}</p>
                        <p class="text-gray-600 text-sm">${tool.description}</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-xl font-bold text-indigo-700">$${tool.price}</span>
                        <button class="buy-tool-btn px-5 py-2 bg-indigo-700 text-white font-bold rounded-lg shadow-md hover:bg-indigo-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 transform hover:scale-105" data-tool-type="${Object.keys(TOOL_TYPES).find(key => TOOL_TYPES[key] === tool)}">
                            Buy
                        </button>
                    </div>
                `;
                const buyBtn = toolDiv.querySelector('.buy-tool-btn');
                buyBtn.disabled = money < tool.price;
                buyBtn.addEventListener('click', () => handleBuyTool(tool));
                toolListContainer.appendChild(toolDiv);
            });
        };

        /**
         * Renders the inventory display.
         */
        const renderInventory = () => {
            // Seeds
            inventorySeedsList.innerHTML = '';
            if (Object.keys(inventory.seeds).length === 0 || Object.values(inventory.seeds).every(count => count === 0)) {
                inventorySeedsList.innerHTML = '<p class="text-white text-opacity-80">No seeds yet!</p>';
            } else {
                for (const type in inventory.seeds) {
                    if (inventory.seeds[type] > 0) {
                        const li = document.createElement('li');
                        li.className = "text-white text-opacity-90";
                        li.textContent = `${SEED_TYPES[type].icon} ${SEED_TYPES[type].name.replace(' Seed', '')}: ${inventory.seeds[type]}`;
                        inventorySeedsList.appendChild(li);
                    }
                }
            }

            // Tools
            inventoryToolsList.innerHTML = '';
            if (Object.keys(inventory.tools).length === 0 || Object.values(inventory.tools).every(count => count === 0)) {
                inventoryToolsList.innerHTML = '<p class="text-white text-opacity-80">No tools yet!</p>';
            } else {
                for (const type in inventory.tools) {
                    if (inventory.tools[type] > 0) {
                        const li = document.createElement('li');
                        li.className = "text-white text-opacity-90";
                        li.textContent = `${TOOL_TYPES[type].icon} ${TOOL_TYPES[type].name}: ${inventory.tools[type]}`;
                        inventoryToolsList.appendChild(li);
                    }
                }
            }

            // Produce
            inventoryProduceListContainer.innerHTML = ''; // Clear previous items
            if (Object.keys(inventory.produce).length === 0 || Object.values(inventory.produce).every(count => count === 0)) {
                inventoryProduceListContainer.innerHTML = '<p class="text-white text-opacity-80">No produce harvested yet!</p>';
            } else {
                for (const type in inventory.produce) {
                    if (inventory.produce[type] > 0) {
                        const produceDiv = document.createElement('div');
                        produceDiv.className = "flex items-center justify-between bg-white bg-opacity-20 p-2 rounded-lg";

                        const produceName = type.charAt(0).toUpperCase() + type.slice(1);
                        const produceIcon = SEED_TYPES[type].icon;
                        const harvestValue = SEED_TYPES[type].harvestValue; // Base value for calculation

                        produceDiv.innerHTML = `
                            <div class="flex-grow">
                                <p class="text-white text-opacity-90">${produceIcon} ${produceName}: <span id="produce-count-${type}">${inventory.produce[type]}</span></p>
                            </div>
                            <div class="flex items-center gap-1">
                                <button class="quantity-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors" data-action="decrease" data-item-type="produce" data-produce-type="${type}">-</button>
                                <input type="number" value="1" min="1" max="${inventory.produce[type]}" class="w-12 text-center border rounded-lg" id="produce-quantity-${type}" readonly>
                                <button class="quantity-btn px-3 py-1 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors" data-action="increase" data-item-type="produce" data-produce-type="${type}">+</button>
                            </div>
                            <button class="sell-produce-btn px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition-colors duration-200 transform hover:scale-105 ml-2" data-produce-type="${type}">
                                Sell ($<span id="sell-price-${type}">${harvestValue}</span>)
                            </button>
                        `;
                        inventoryProduceListContainer.appendChild(produceDiv);

                        const quantityInput = document.getElementById(`produce-quantity-${type}`);
                        const sellBtn = produceDiv.querySelector('.sell-produce-btn');

                        const updateSellButtonState = () => {
                            const quantity = parseInt(quantityInput.value);
                            const totalSellValue = harvestValue * quantity; // This assumes base value. Weight applied at harvest.
                            sellBtn.disabled = quantity === 0 || inventory.produce[type] < quantity;
                            produceDiv.querySelector(`#sell-price-${type}`).textContent = totalSellValue;
                        };

                        produceDiv.querySelectorAll('.quantity-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                let quantity = parseInt(quantityInput.value);
                                if (btn.dataset.action === 'increase') {
                                    quantity = Math.min(inventory.produce[type], quantity + 1);
                                } else if (btn.dataset.action === 'decrease') {
                                    quantity = Math.max(1, quantity - 1);
                                }
                                quantityInput.value = quantity;
                                updateSellButtonState();
                            });
                        });

                        sellBtn.addEventListener('click', () => {
                            const quantity = parseInt(quantityInput.value);
                            handleSellProduce(type, quantity);
                            quantityInput.value = 1; // Reset quantity after selling
                        });
                        updateSellButtonState(); // Initial state update
                    }
                }
            }
        };

        /**
         * Renders all garden plots.
         */
        const renderGardenPlots = () => {
            gardenPlotsContainer.innerHTML = ''; // Clear previous plots
            plants.forEach((plant, index) => {
                const plotDiv = document.createElement('div');
                plotDiv.className = "relative"; // For positioning growth overlay and weather effects

                if (plant) {
                    const seedInfo = SEED_TYPES[plant.type];
                    const growthPercentage = Math.min(100, (plant.growth / plant.maxGrowthTime) * 100);
                    const isGrown = growthPercentage >= 100;

                    // Calculate dynamic emoji size
                    let emojiSizePx;
                    if (isGrown) {
                        // When grown, size is influenced by its actual harvested/potential size multiplier
                        const finalSizeMultiplier = plant.appliedSprinklerSizeBonus || 1; // Use the sprinkler bonus if applied
                        emojiSizePx = seedInfo.grownEmojiSize * finalSizeMultiplier;
                    } else {
                        // While growing, interpolate size from base to grown size
                        emojiSizePx = seedInfo.baseEmojiSize + (seedInfo.grownEmojiSize - seedInfo.baseEmojiSize) * (growthPercentage / 100);
                    }

                    plotDiv.innerHTML = `
                        <div class="bg-amber-700 bg-opacity-70 border-4 border-amber-800 rounded-xl shadow-xl p-4 flex flex-col items-center justify-center min-h-[150px] transition-all duration-300 hover:scale-[1.02] cursor-pointer">
                            <p class="plant-emoji-size mb-2" style="font-size: ${emojiSizePx}rem;">${seedInfo.icon}</p>
                            <p class="text-xl font-bold text-white text-center">${seedInfo.name.replace(' Seed', '')} ${plant.isMutated ? '(Mutated!)' : ''}</p>
                            <div class="growth-overlay absolute inset-0 flex items-center justify-center bg-black bg-opacity-70 rounded-xl text-white text-3xl font-extrabold transition-opacity duration-200 hidden">
                                ${isGrown ? 'Ready! üíØ' : `${Math.floor(growthPercentage)}%`}
                            </div>
                            <!-- Weather Effects -->
                            ${plant.isWet && isGrown ? '<span class="weather-effect-emoji weather-effect-drop">üíß</span>' : ''}
                            ${plant.struckByLightning && isGrown ? '<span class="weather-effect-emoji weather-effect-lightning">‚ö°</span>' : ''}
                            <div class="mt-auto flex gap-2">
                                ${!isGrown && (inventory.tools.wateringCan || 0) > 0 && !plant.wateredUsingWateringCan ? `
                                    <button class="apply-tool-btn mt-3 px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors duration-200 transform hover:scale-105" data-plant-id="${plant.id}" data-tool-type="wateringCan">
                                        üíß Water
                                    </button>
                                ` : ''}
                                ${!isGrown && (inventory.tools.superFertilizer || 0) > 0 && !plant.fertilizedUsingSuperFertilizer ? `
                                    <button class="apply-tool-btn mt-3 px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition-colors duration-200 transform hover:scale-105" data-plant-id="${plant.id}" data-tool-type="superFertilizer">
                                        ‚ú® Fertilize
                                    </button>
                                ` : ''}
                                ${isGrown ? `
                                    <button class="harvest-btn mt-3 px-4 py-2 bg-emerald-500 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 transition-colors duration-200 transform hover:scale-105" data-plot-index="${index}">
                                        Harvest üß∫
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    // Add event listeners for tool application and harvesting
                    plotDiv.querySelector('.bg-amber-700').addEventListener('click', (event) => {
                        // Only show overlay if not clicking a button within the plot
                        if (!event.target.closest('button')) {
                            const overlay = plotDiv.querySelector('.growth-overlay');
                            overlay.classList.toggle('hidden');
                        }
                    });

                    // Add event listeners for tool buttons inside the plot (if they exist)
                    plotDiv.querySelectorAll('.apply-tool-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            event.stopPropagation(); // Prevent plot click from firing
                            const plantId = button.dataset.plantId;
                            const toolType = button.dataset.toolType;
                            handleApplyTool(plantId, toolType);
                        });
                    });

                    // Add event listener for harvest button
                    const harvestBtn = plotDiv.querySelector('.harvest-btn');
                    if (harvestBtn) {
                        harvestBtn.addEventListener('click', () => handleHarvest(index));
                    }

                } else {
                    plotDiv.innerHTML = `
                        <div class="bg-amber-700 bg-opacity-40 border-4 border-amber-800 border-dashed rounded-xl shadow-inner p-4 flex flex-col items-center justify-center min-h-[150px] transition-all duration-300 hover:scale-[1.02] cursor-pointer plot-empty">
                            <p class="text-6xl text-amber-800 text-opacity-50">‚ûï</p>
                            <p class="text-lg font-semibold text-amber-800 text-opacity-70 mt-2">Empty Plot</p>
                            <button class="plant-seed-btn mt-3 px-4 py-2 bg-emerald-500 text-white font-semibold rounded-lg shadow-md hover:bg-emerald-600 transition-colors duration-200 transform hover:scale-105" data-plot-index="${index}">
                                Plant Seed
                            </button>
                        </div>
                    `;
                    // Add event listener for planting a seed
                    plotDiv.querySelector('.plant-seed-btn').addEventListener('click', () => handlePlantSeed(index));
                }
                gardenPlotsContainer.appendChild(plotDiv);
            });
        };


        /**
         * Handles buying a seed from the shop.
         * @param {object} seed - The seed type object.
         * @param {number} quantity - The quantity to buy.
         */
        const handleBuySeed = (seed, quantity) => {
            const totalPrice = seed.price * quantity;
            if (money >= totalPrice) {
                money -= totalPrice;
                inventory.seeds[Object.keys(SEED_TYPES).find(key => SEED_TYPES[key] === seed)] = 
                    (inventory.seeds[Object.keys(SEED_TYPES).find(key => SEED_TYPES[key] === seed)] || 0) + quantity;
                updateMoneyDisplay();
                renderInventory();
                showMessage(`Bought ${quantity} ${seed.name}(s) for $${totalPrice}!`);
            } else {
                showMessage('Not enough money!');
            }
        };

        /**
         * Handles buying a tool from the shop.
         * @param {object} tool - The tool type object.
         */
        const handleBuyTool = (tool) => {
            const toolTypeKey = Object.keys(TOOL_TYPES).find(key => TOOL_TYPES[key] === tool);
            if (money >= tool.price) {
                money -= tool.price;
                inventory.tools[toolTypeKey] = (inventory.tools[toolTypeKey] || 0) + 1;
                updateMoneyDisplay();
                renderInventory();
                showMessage(`Bought 1 ${tool.name} for $${tool.price}!`);
            } else {
                showMessage('Not enough money!');
            }
        };

        /**
         * Handles planting a seed in a garden plot.
         * @param {number} plotIndex - The index of the garden plot.
         */
        const handlePlantSeed = (plotIndex) => {
            // For simplicity, let's allow planting the first available seed in inventory.
            // In a real game, a seed selection UI would be needed.
            const availableSeedTypes = Object.keys(inventory.seeds).filter(type => inventory.seeds[type] > 0);

            if (availableSeedTypes.length === 0) {
                showMessage("You don't have any seeds to plant! Buy some from the shop.");
                return;
            }

            // Take the first available seed type from inventory
            const seedTypeToPlant = availableSeedTypes[0];
            const seedInfo = SEED_TYPES[seedTypeToPlant];

            if (plants[plotIndex] === null) {
                plants[plotIndex] = {
                    id: crypto.randomUUID(), // Unique ID for the plant instance
                    type: seedTypeToPlant,
                    growth: 0,
                    maxGrowthTime: seedInfo.growthTime,
                    lastGrowthUpdate: Date.now(),
                    wateredUsingWateringCan: false,
                    fertilizedUsingSuperFertilizer: false,
                    appliedSprinklerGrowthBonus: 1, // Default no sprinkler bonus
                    appliedSprinklerSizeBonus: 1, // Default no sprinkler size bonus
                    isMutated: false, // For mutation mechanic
                    isWet: currentWeather ? currentWeather.isWet : false, // Initial wet status based on current weather
                    struckByLightning: false, // Initial lightning status
                };
                inventory.seeds[seedTypeToPlant]--; // Consume one seed
                renderInventory();
                renderGardenPlots();
                showMessage(`Planted a ${seedInfo.name.replace(' Seed', '')}!`);
            } else {
                showMessage('This plot is already occupied!');
            }
        };

        /**
         * Handles applying a tool to a plant.
         * @param {string} plantId - The ID of the plant.
         * @param {string} toolType - The type of tool to apply.
         */
        const handleApplyTool = (plantId, toolType) => {
            const plantIndex = plants.findIndex(p => p && p.id === plantId);
            if (plantIndex === -1) return;

            const plant = plants[plantIndex];
            const tool = TOOL_TYPES[toolType];

            if (inventory.tools[toolType] > 0) {
                if (plant.growth >= plant.maxGrowthTime) {
                    showMessage(`This ${SEED_TYPES[plant.type].name.replace(' Seed', '')} is already fully grown!`);
                    return;
                }

                inventory.tools[toolType]--; // Consume one tool
                
                if (tool.growthBoostFactor) {
                    plant.maxGrowthTime /= tool.growthBoostFactor; // Reduce remaining growth time
                    // Set flags to prevent re-application of single-use growth tools
                    if (toolType === 'wateringCan') plant.wateredUsingWateringCan = true;
                    if (toolType === 'superFertilizer') plant.fertilizedUsingSuperFertilizer = true;
                }

                if (tool.growthBoostFactor && (toolType === 'basicSprinkler' || toolType === 'advancedSprinkler')) {
                    plant.appliedSprinklerGrowthBonus = tool.growthBoostFactor;
                    plant.appliedSprinklerSizeBonus = tool.sizeBonusMultiplier;

                    // Apply mutation chance
                    if (Math.random() < tool.mutationChance) {
                        plant.isMutated = true;
                        showMessage(`Woah! Your ${SEED_TYPES[plant.type].name.replace(' Seed', '')} mutated! It might yield more or be extra valuable!`);
                    }
                }

                updateMoneyDisplay(); // Not directly affecting money, but rerenders inventory if needed
                renderInventory();
                renderGardenPlots(); // Re-render to update tool buttons on plot
                showMessage(`Applied ${tool.name} to your ${SEED_TYPES[plant.type].name.replace(' Seed', '')}!`);
            } else {
                showMessage(`You don't have any ${tool.name}s!`);
            }
        };

        /**
         * Handles harvesting a fully grown plant.
         * @param {number} plotIndex - The index of the garden plot.
         */
        const handleHarvest = (plotIndex) => {
            const plant = plants[plotIndex];
            if (plant && plant.growth >= plant.maxGrowthTime) {
                const seedInfo = SEED_TYPES[plant.type];
                const yieldAmount = seedInfo.yield.amount;
                const baseHarvestValue = seedInfo.harvestValue;

                // Calculate random weight multiplier
                let weightMultiplier = Math.random() * (seedInfo.maxWeightMultiplier - seedInfo.minWeightMultiplier) + seedInfo.minWeightMultiplier;
                
                // Apply sprinkler size bonus if it was used and mutated
                if (plant.isMutated && plant.appliedSprinklerSizeBonus > 1) {
                    weightMultiplier *= plant.appliedSprinklerSizeBonus;
                    showMessage(`Your mutated ${seedInfo.name.replace(' Seed', '')} grew extra large!`);
                }

                let totalHarvestValue = Math.round(baseHarvestValue * weightMultiplier * yieldAmount); // Round to nearest integer

                // Apply mutation bonus to sell value
                if (plant.isMutated) {
                    totalHarvestValue = Math.round(totalHarvestValue * 1.25); // 25% bonus for mutated plants
                    showMessage(`Your mutated ${seedInfo.yield.produce.charAt(0).toUpperCase() + seedInfo.yield.produce.slice(1)} fetched a bonus price!`);
                }


                inventory.produce[seedInfo.yield.produce] = (inventory.produce[seedInfo.yield.produce] || 0) + yieldAmount;
                
                // Remove the plant from the plot
                plants[plotIndex] = null;
                renderGardenPlots();
                renderInventory();
                showMessage(`Harvested ${yieldAmount} ${seedInfo.yield.produce}(s)! You can sell them for value based on size and mutation!`);
            } else {
                showMessage('This plant is not ready to be harvested yet!');
            }
        };

        /**
         * Handles selling produce from the inventory.
         * @param {string} produceType - The type of produce to sell.
         * @param {number} quantity - The quantity to sell.
         */
        const handleSellProduce = (produceType, quantity) => {
            if (inventory.produce[produceType] >= quantity) {
                const seedInfo = SEED_TYPES[produceType];
                // Assuming average value for selling produce from inventory, as individual weights aren't stored
                const valuePerUnit = seedInfo.harvestValue; 
                const totalValue = valuePerUnit * quantity;

                money += totalValue;
                inventory.produce[produceType] -= quantity;
                updateMoneyDisplay();
                renderInventory();
                showMessage(`Sold ${quantity} ${produceType}(s) for $${totalValue}!`);
            } else {
                showMessage(`You don't have enough ${produceType}(s) to sell!`);
            }
        };

        /**
         * Updates the shop reset timer display.
         */
        const updateShopTimer = () => {
            const minutes = Math.floor(shopResetTimer / 60);
            const seconds = shopResetTimer % 60;
            shopTimerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        };

        /**
         * Resets the shop with new items.
         */
        const resetShop = () => {
            shopSeeds = generateShopSeeds();
            shopTools = generateShopTools();
            renderSeedShop();
            renderToolShop();
            shopResetTimer = SHOP_RESET_INTERVAL; // Reset timer
            updateShopTimer();
            showMessage('Shop has been restocked!');
        };

        /**
         * Activates a specified weather type and sets a timer for its duration.
         * @param {string} weatherTypeKey - The key of the weather type to activate (e.g., 'rain', 'thunderstorm', 'clear').
         */
        const activateWeather = (weatherTypeKey) => {
            if (weatherTimerId) {
                clearTimeout(weatherTimerId); // Clear any existing weather timer
            }
            
            const selectedWeather = WEATHER_TYPES[weatherTypeKey];
            currentWeather = selectedWeather;
            currentWeatherDisplay.textContent = `${selectedWeather.icon} ${selectedWeather.name}`;
            showMessage(`${selectedWeather.name} started! It will last for ${WEATHER_ACTIVE_DURATION / 1000} seconds.`);

            // Apply visual effects to the weather overlay
            weatherOverlay.className = 'fixed inset-0 pointer-events-none z-30'; // Reset classes
            if (weatherTypeKey === 'rain') {
                weatherOverlay.classList.add('rain-effect');
            } else if (weatherTypeKey === 'thunderstorm') {
                weatherOverlay.classList.add('thunderstorm-effect');
            } else if (weatherTypeKey === 'snow') {
                weatherOverlay.classList.add('snow-effect');
            } else if (weatherTypeKey === 'fog') {
                weatherOverlay.classList.add('fog-effect');
            }

            // Apply immediate weather effects to plants
            plants.forEach(plant => {
                if (plant) {
                    // Update wet status for all plants
                    plant.isWet = currentWeather.isWet;
                    
                    // Only apply lightning if thunderstorm is active AND plant is grown
                    if (currentWeather.canStrikeLightning && (plant.growth / plant.maxGrowthTime) >= 1 && Math.random() < 0.15) { // 15% chance per grown plant
                        plant.struckByLightning = true;
                        // Future: Add negative or positive effects of lightning (e.g., destroy plant, supercharge growth)
                    } else {
                        plant.struckByLightning = false; // Ensure lightning effect is cleared if not struck
                    }
                }
            });
            renderGardenPlots(); // Re-render to show effects

            // Set timer to deactivate weather
            weatherTimerId = setTimeout(() => {
                deactivateWeather();
                showMessage(`${selectedWeather.name} ended.`);
            }, WEATHER_ACTIVE_DURATION);
        };

        /**
         * Deactivates the current weather and removes its effects from plants.
         */
        const deactivateWeather = () => {
            currentWeather = null;
            currentWeatherDisplay.textContent = 'None';
            // Remove all weather effect classes from the overlay
            weatherOverlay.className = 'fixed inset-0 pointer-events-none z-30';
            
            plants.forEach(plant => {
                if (plant) {
                    plant.isWet = false;
                    plant.struckByLightning = false;
                }
            });
            renderGardenPlots(); // Re-render to remove effects
            if (weatherTimerId) {
                clearTimeout(weatherTimerId);
                weatherTimerId = null;
            }
        };

        // --- Game Initialization ---
        const initGame = () => {
            updateMoneyDisplay();
            resetShop(); // Initial shop stock
            renderInventory();
            renderGardenPlots();
            deactivateWeather(); // Ensure clear weather initially

            // Set up shop reset interval
            setInterval(() => {
                shopResetTimer--;
                if (shopResetTimer <= 0) {
                    resetShop();
                } else {
                    updateShopTimer();
                }
            }, 1000); // Update every second

            // Game loop for plant growth
            setInterval(() => {
                plants.forEach(plant => {
                    if (plant && plant.growth < plant.maxGrowthTime) {
                        const timeElapsed = (Date.now() - plant.lastGrowthUpdate);
                        plant.growth += timeElapsed * plant.appliedSprinklerGrowthBonus; // Apply sprinkler growth bonus
                        plant.lastGrowthUpdate = Date.now();
                        renderGardenPlots(); // Re-render plots to show growth progress
                    }
                });
            }, 500); // Update growth every 0.5 seconds
        };

        // --- Event Listeners for Weather Controls ---
        weatherClearBtn.addEventListener('click', () => activateWeather('clear'));
        weatherRainBtn.addEventListener('click', () => activateWeather('rain'));
        weatherThunderstormBtn.addEventListener('click', () => activateWeather('thunderstorm'));
        weatherSnowBtn.addEventListener('click', () => activateWeather('snow')); // New event listener
        weatherFogBtn.addEventListener('click', () => activateWeather('fog'));   // New event listener

        // Initialize the game when the window loads
        window.addEventListener('load', initGame);
    </script>
</body>
</html>